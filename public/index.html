<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Car Stint Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Rajdhani', sans-serif;
            background: #0a0a0a;
            color: #fff;
            font-size: 13px;
        }
        .orbitron { font-family: 'Orbitron', monospace; }
        .timer-xl { font-size: 2rem; line-height: 1; font-weight: 800; }
        .timer-lg { font-size: 1.5rem; line-height: 1; font-weight: 700; }
        .timer-md { font-size: 1.25rem; line-height: 1; font-weight: 600; }
        .timer-sm { font-size: 1rem; line-height: 1; font-weight: 600; }
        .pulse { animation: pulse 1s infinite; }
        .pulse-fast { animation: pulse 0.5s infinite; }
        .blink-red { animation: blink-red 0.5s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes blink-red {
            0%, 100% { 
                background: linear-gradient(135deg, rgba(220, 38, 38, 0.3), rgba(185, 28, 28, 0.3));
                border-color: rgba(239, 68, 68, 0.8);
            }
            50% { 
                background: linear-gradient(135deg, rgba(220, 38, 38, 0.6), rgba(185, 28, 28, 0.6));
                border-color: rgba(239, 68, 68, 1);
            }
        }
        .panel {
            background: linear-gradient(135deg, rgba(30,30,30,0.95), rgba(20,20,20,0.95));
            border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #e10600, transparent);
        }
        .btn {
            background: linear-gradient(135deg, #e10600, #ff3838);
            padding: 6px 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s;
            font-size: 11px;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(225,6,0,0.4);
        }
        .btn:disabled { opacity: 0.3; }
        .btn-sec {
            background: linear-gradient(135deg, #1e1e1e, #2a2a2a);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .stint-card {
            background: linear-gradient(135deg, rgba(40,40,40,0.8), rgba(30,30,30,0.8));
            border-left: 2px solid #e10600;
        }
        .stint-card.target-met { border-left-color: #22c55e; }
        .stint-card.over-max { border-left-color: #ef4444; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function CarPanel({ carNumber, carName, drivers }) {
            const [raceState, setRaceState] = useState(null);
            const [driverName, setDriverName] = useState('');
            const [lastTargetReached, setLastTargetReached] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());
            const audioRef = useRef(null);
            const driverInputRef = useRef(null);

            useEffect(() => {
                audioRef.current = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
                updateDisplay();
                // Use faster update rate in simulation mode for smoother display
                const updateInterval = raceState?.simulationMode ? 100 : 1000;
                const interval = setInterval(updateDisplay, updateInterval);
                return () => clearInterval(interval);
            }, [carNumber, raceState?.simulationMode]);

            useEffect(() => {
                if (raceState && raceState.targetStintReached && !lastTargetReached) {
                    audioRef.current?.play().catch(e => {});
                    setLastTargetReached(true);
                } else if (raceState && !raceState.targetStintReached) {
                    setLastTargetReached(false);
                }
            }, [raceState?.targetStintReached]);

            useEffect(() => {
                const clockInterval = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(clockInterval);
            }, []);

            const updateDisplay = async () => {
                try {
                    const res = await fetch(`/api/race-state/${carNumber}`);
                    const data = await res.json();
                    setRaceState(data);
                } catch (error) {
                    console.error('Error:', error);
                }
            };

            const startRace = async () => {
                if (!driverName.trim()) return;
                await fetch(`/api/start-race/${carNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ driverName })
                });
                setDriverName('');
                updateDisplay();
            };

            const changeDriver = async () => {
                if (!driverName.trim()) return;
                await fetch(`/api/change-driver/${carNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ driverName })
                });
                setDriverName('');
                updateDisplay();
            };

            // Get next driver in rotation
            const getNextDriver = () => {
                if (!drivers || drivers.length === 0) return null;
                if (!raceState.currentDriver) return drivers[0];
                
                const currentIndex = drivers.indexOf(raceState.currentDriver);
                if (currentIndex === -1) return drivers[0];
                
                const nextIndex = (currentIndex + 1) % drivers.length;
                return drivers[nextIndex];
            };

            // Auto-select next driver
            const autoSelectNextDriver = () => {
                const nextDriver = getNextDriver();
                if (nextDriver) {
                    setDriverName(nextDriver);
                    // Focus the input to make it clear the user can edit
                    setTimeout(() => driverInputRef.current?.focus(), 0);
                }
            };

            const pauseStint = async () => {
                await fetch(`/api/pause-stint/${carNumber}`, { method: 'POST' });
                updateDisplay();
            };

            const resumeStint = async () => {
                await fetch(`/api/resume-stint/${carNumber}`, { method: 'POST' });
                updateDisplay();
            };

            const endRace = async () => {
                if (!confirm('End race?')) return;
                await fetch(`/api/end-race/${carNumber}`, { method: 'POST' });
                updateDisplay();
            };

            // Calculate driver statistics
            const getDriverStats = () => {
                if (!raceState || !raceState.stintHistory || raceState.stintHistory.length === 0) {
                    return {};
                }

                const stats = {};
                
                raceState.stintHistory.forEach(stint => {
                    if (!stats[stint.driver]) {
                        stats[stint.driver] = {
                            totalTime: 0,
                            stintCount: 0,
                            stints: []
                        };
                    }
                    stats[stint.driver].totalTime += stint.duration;
                    stats[stint.driver].stintCount += 1;
                    stats[stint.driver].stints.push(stint);
                });

                // Calculate averages
                Object.keys(stats).forEach(driver => {
                    stats[driver].average = stats[driver].totalTime / stats[driver].stintCount;
                });

                return stats;
            };

            const formatTime = (ms) => {
                if (ms < 0) ms = 0;
                const s = Math.floor(ms / 1000);
                const h = Math.floor(s / 3600);
                const m = Math.floor((s % 3600) / 60);
                const sec = s % 60;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
            };

            const formatTimeShort = (ms) => {
                const s = Math.floor(ms / 1000);
                const m = Math.floor(s / 60);
                const sec = s % 60;
                return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
            };

            const getTimerColor = (time, target, max) => {
                if (time >= max) return 'text-red-500';
                if (time >= target) return 'text-yellow-400';
                return 'text-green-500';
            };

            if (!raceState) {
                return <div className="flex items-center justify-center h-full">
                    <div className="orbitron text-red-500 text-lg animate-pulse">LOADING...</div>
                </div>;
            }

            return (
                <div className="flex flex-col h-full">
                    {/* Header */}
                    <div className="panel p-2 rounded-none mb-2">
                        <div className="flex justify-between items-center">
                            <div>
                                <div className="orbitron text-xl font-black text-red-500">#{carNumber}</div>
                                <div className="text-gray-400 text-xs">{carName}</div>
                                {raceState.isRaceActive &&
                                 raceState.timeInCar >= (raceState.currentStintTargetFrozen - 150000) &&
                                 raceState.timeInCar < raceState.currentStintTargetFrozen && (
                                    <div className="orbitron text-sm font-black text-yellow-400 mt-1 animate-pulse">
                                        🏁 PIT BOARD OUT
                                    </div>
                                )}
                            </div>
                            <div className="text-right">
                                <div className="orbitron text-sm text-gray-400 mb-1">
                                    {currentTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}
                                </div>
                                <div className={`orbitron text-lg font-bold ${
                                    !raceState.isRaceActive ? 'text-gray-500' :
                                    raceState.isPaused ? 'text-yellow-400' : 'text-green-500'
                                }`}>
                                    {!raceState.isRaceActive ? 'READY' : raceState.isPaused ? 'PAUSE' : 'LIVE'}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Driver */}
                    <div className="panel p-2 rounded-none mb-2">
                        <div className="text-gray-400 text-xs">DRIVER</div>
                        <div className="orbitron text-2xl font-black text-white truncate">
                            {raceState.currentDriver || '---'}
                        </div>
                    </div>

                    {/* Main Timer */}
                    <div className={`panel p-3 rounded-none mb-2 ${
                        raceState.targetStintReached ? 'border-2 border-green-500' : ''
                    } ${
                        raceState.timeInCar >= raceState.maxStintTime - 5 * 60 * 1000 ? 'blink-red border-2' : ''
                    }`}>
                        <div className="text-gray-400 text-xs mb-1">TIME IN CAR</div>
                        {raceState.targetStintReached && raceState.timeInCar < raceState.maxStintTime - 5 * 60 * 1000 && (
                            <div className="text-green-500 font-bold text-xs mb-1 pulse">✓ TARGET</div>
                        )}
                        {raceState.timeRemaining > 0 && raceState.timeRemaining <= 5 * 60 * 1000 && raceState.timeInCar < raceState.maxStintTime - 5 * 60 * 1000 && (
                            <div className="text-yellow-400 font-bold text-xs mb-1 pulse">⚠ 5 MIN TO TARGET!</div>
                        )}
                        {raceState.timeInCar >= raceState.maxStintTime - 5 * 60 * 1000 && raceState.timeInCar < raceState.maxStintTime && (
                            <div className="text-red-500 font-bold text-xs mb-1 pulse-fast">⚠ 5 MIN TO MAX!</div>
                        )}
                        {raceState.timeInCar >= raceState.maxStintTime && (
                            <div className="text-red-500 font-bold text-xs mb-1 pulse-fast">⚠ OVER MAX TIME!</div>
                        )}
                        <div className="flex justify-between items-center">
                            <div>
                                <div className={`orbitron timer-xl ${getTimerColor(raceState.timeInCar, raceState.targetStintTime, raceState.maxStintTime)} ${
                                    raceState.timeInCar >= raceState.maxStintTime ? 'pulse-fast' :
                                    raceState.timeInCar >= raceState.targetStintTime ? 'pulse' : ''
                                }`}>
                                    {formatTime(raceState.timeInCar)}
                                </div>
                                {raceState.isRaceActive && raceState.timeInCar > 0 && (
                                    <div className="text-xs mt-1">
                                        <span className="text-gray-400">Δ Time off target: </span>
                                        <span className={`orbitron font-bold ${
                                            raceState.timeInCar > raceState.currentStintTargetFrozen ? 'text-red-400' : 'text-green-400'
                                        }`}>
                                            {(() => {
                                                const diff = raceState.timeInCar - raceState.currentStintTargetFrozen;
                                                const sign = diff > 0 ? '+' : diff < 0 ? '-' : '';
                                                const absDiff = Math.abs(diff);
                                                const mins = Math.floor(absDiff / 60000);
                                                const secs = Math.floor((absDiff % 60000) / 1000);
                                                return `${sign}${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                                            })()}
                                        </span>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-2 text-xs">
                                <div className="text-gray-400">TGT: <span className="text-yellow-400 orbitron">{formatTimeShort(raceState.targetStintTime)}</span></div>
                                <div className="text-gray-400">MAX: <span className="text-red-500 orbitron">{formatTimeShort(raceState.maxStintTime)}</span></div>
                            </div>
                        </div>
                        {raceState.currentStintTargetCalc > 0 && (
                            <div className="mt-1 text-xs flex justify-between items-center">
                                <div className="text-gray-400">
                                    This stint: <span className="text-green-400 orbitron font-bold">{formatTimeShort(raceState.currentStintTargetCalc)}</span>
                                    <span className="text-gray-500 ml-1">(frozen)</span>
                                </div>
                                {raceState.currentStintTargetFrozen > 0 && (
                                    <div className="text-gray-400">
                                        Stint ends: <span className="text-cyan-400 orbitron font-bold">
                                            {(() => {
                                                const timeLeftInCurrentStint = Math.max(0, raceState.currentStintTargetFrozen - raceState.timeInCar);
                                                const stintEndTime = new Date(Date.now() + timeLeftInCurrentStint);
                                                return stintEndTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                                            })()}
                                        </span>
                                        <span className="text-gray-500 ml-1">(live)</span>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>

                    {/* Time Grid */}
                    <div className="grid grid-cols-2 gap-2 mb-2">
                        <div className="panel p-2 rounded-none text-center">
                            <div className="text-gray-400 text-xs">
                                {raceState.timeRemaining <= 0 ? 'OVER TARGET' : 'STINT LEFT'}
                            </div>
                            <div className={`orbitron timer-md ${raceState.timeRemaining <= 0 ? 'text-red-500' : 'text-green-500'}`}>
                                {raceState.timeRemaining <= 0 ? '+' : ''}{formatTimeShort(Math.abs(raceState.timeRemaining))}
                            </div>
                        </div>
                        <div className="panel p-2 rounded-none text-center">
                            <div className="text-gray-400 text-xs">RACE LEFT</div>
                            <div className="orbitron timer-md text-white">{formatTime(raceState.totalRaceTimeRemaining)}</div>
                        </div>
                    </div>

                    {/* Stats Grid */}
                    <div className="grid grid-cols-3 gap-2 mb-2">
                        <div className="panel p-2 rounded-none text-center">
                            <div className="text-gray-400 text-xs">CHANGES</div>
                            <div className="orbitron timer-sm text-white">
                                {raceState.driverChanges}/{raceState.plannedChanges || 11}
                            </div>
                        </div>
                        <div className="panel p-2 rounded-none text-center">
                            <div className="text-gray-400 text-xs">STINTS LEFT</div>
                            <div className="orbitron timer-sm text-cyan-400">{raceState.stintsRemaining || 0}</div>
                        </div>
                        <div className="panel p-2 rounded-none text-center">
                            <div className="text-gray-400 text-xs">NEXT STINTS</div>
                            <div className="orbitron timer-sm text-cyan-400">
                                {raceState.isRaceActive ? formatTimeShort(raceState.requiredStintTime) : '--:--'}
                            </div>
                        </div>
                    </div>

                    {/* Upcoming Driver Alert */}
                    {raceState.isRaceActive && getNextDriver() && (
                        <div className="panel p-2 rounded-none mb-2 border-l-2 border-yellow-500 bg-gradient-to-r from-yellow-900/20 to-transparent">
                            <div className="flex justify-between items-center">
                                <div className="flex-1">
                                    <div className="text-yellow-400 text-xs font-bold">👤 NEXT DRIVER</div>
                                    <div className="text-white text-lg font-bold">{getNextDriver()}</div>
                                    {raceState.currentStintTargetCalc > 0 && (
                                        <div className="text-xs mt-1 flex justify-between items-center">
                                            <div>
                                                <span className="text-gray-400">Time to change: </span>
                                                <span className={`orbitron font-bold ${
                                                    (raceState.currentStintTargetCalc - raceState.timeInCar) <= 0
                                                        ? 'text-red-500'
                                                        : (raceState.currentStintTargetCalc - raceState.timeInCar) <= 5 * 60 * 1000
                                                            ? 'text-yellow-400'
                                                            : 'text-green-500'
                                                }`}>
                                                    {formatTimeShort(Math.max(0, raceState.currentStintTargetCalc - raceState.timeInCar))}
                                                </span>
                                            </div>
                                            <div>
                                                <span className="text-gray-400">Change at: </span>
                                                <span className="orbitron font-bold text-cyan-400">
                                                    {(() => {
                                                        const timeRemaining = Math.max(0, raceState.currentStintTargetCalc - raceState.timeInCar);
                                                        const estimatedTime = new Date(Date.now() + timeRemaining);
                                                        return estimatedTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                                                    })()}
                                                </span>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <button
                                    onClick={autoSelectNextDriver}
                                    className="btn-sec rounded-none text-xs px-3 py-1 hover:bg-yellow-600"
                                >
                                    AUTO-SELECT
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Controls */}
                    <div className="panel p-2 rounded-none mb-2">
                        <input
                            ref={driverInputRef}
                            type="text"
                            value={driverName}
                            onChange={(e) => setDriverName(e.target.value)}
                            onFocus={(e) => e.target.select()}
                            onKeyPress={(e) => {
                                if (e.key === 'Enter') {
                                    if (!raceState.isRaceActive) startRace();
                                    else changeDriver();
                                }
                            }}
                            placeholder="DRIVER"
                            className="w-full px-2 py-1 rounded-none bg-black border border-gray-700 text-white text-sm mb-2"
                            list={`drivers-${carNumber}`}
                        />
                        <datalist id={`drivers-${carNumber}`}>
                            {drivers?.map((d, i) => <option key={i} value={d} />)}
                        </datalist>
                        <div className="grid grid-cols-4 gap-1 mb-1">
                            <button onClick={startRace} disabled={raceState.isRaceActive} className="btn rounded-none py-1 col-span-2">START</button>
                            <button onClick={changeDriver} disabled={!raceState.isRaceActive} className="btn rounded-none py-1 col-span-2">CHANGE</button>
                        </div>
                        <div className="grid grid-cols-3 gap-1">
                            <button onClick={pauseStint} disabled={!raceState.isRaceActive || !raceState.stintStartTime || raceState.isPaused} className="btn-sec rounded-none py-1">PAUSE</button>
                            <button onClick={resumeStint} disabled={!raceState.isRaceActive || !raceState.isPaused} className="btn-sec rounded-none py-1">RESUME</button>
                            <button onClick={endRace} disabled={!raceState.isRaceActive} className="btn rounded-none py-1 bg-red-900">END</button>
                        </div>
                    </div>

                    {/* Remaining Stints Plan Table */}
                    {raceState.isRaceActive && raceState.stintsRemaining > 1 && (
                        <div className="panel p-3 rounded-none mb-2 flex-1 flex flex-col overflow-hidden">
                            <div className="text-cyan-400 text-xs font-bold mb-2">📋 REMAINING STINTS PLAN</div>
                            <div className="flex-1 overflow-y-auto">
                                <table className="w-full text-xs">
                                    <thead className="sticky top-0 bg-gray-900">
                                        <tr className="text-gray-400 border-b border-gray-700">
                                            <th className="text-left py-1">Stint</th>
                                            <th className="text-right py-1">Duration</th>
                                            <th className="text-right py-1">End Time</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Array.from({ length: raceState.stintsRemaining - 1 }, (_, i) => {
                                            const futureStintIndex = i + 1; // Skip current stint (index 0)
                                            const stintNumber = raceState.driverChanges + futureStintIndex + 1;

                                            // Calculate cumulative time for end time
                                            // Start with current stint total
                                            const currentStintTotal = Math.max(0, raceState.currentStintTargetFrozen - raceState.timeInCar) + raceState.timeInCar;
                                            // Add all future stints before this one (i stints, since futureStintIndex = i + 1)
                                            const cumulativeTime = currentStintTotal + (raceState.requiredStintTime * futureStintIndex);

                                            // Calculate end time based on race start
                                            const raceStartTime = raceState.raceStartTime ? new Date(raceState.raceStartTime) : new Date();
                                            const endTime = new Date(raceStartTime.getTime() + cumulativeTime);
                                            const endTimeStr = endTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });

                                            const duration = raceState.requiredStintTime;

                                            return (
                                                <tr key={i} className="text-white">
                                                    <td className="py-1">
                                                        <span>#{stintNumber}</span>
                                                    </td>
                                                    <td className="text-right orbitron">
                                                        {formatTimeShort(duration)}
                                                    </td>
                                                    <td className="text-right orbitron">
                                                        {endTimeStr}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-2 pt-2 border-t border-gray-700 flex justify-between text-xs">
                                <span className="text-gray-400">Total Remaining:</span>
                                <span className="orbitron text-white font-bold">{formatTime(raceState.totalRaceTimeRemaining)}</span>
                            </div>
                        </div>
                    )}

                    {/* History */}
                    <div className="panel p-2 rounded-none flex-1 overflow-hidden">
                        <div className="text-gray-400 text-xs mb-1">STINT HISTORY</div>
                        
                        {/* Driver Stats Summary */}
                        {raceState.stintHistory.length > 0 && (
                            <div className="mb-2 border border-gray-700 rounded-none">
                                <div className="bg-gray-900 px-2 py-1">
                                    <div className="text-cyan-400 text-xs font-bold">DRIVER AVERAGES</div>
                                </div>
                                <div className="max-h-[120px] overflow-y-auto">
                                    {Object.entries(getDriverStats()).map(([driver, stats]) => (
                                        <div key={driver} className="flex justify-between items-center px-2 py-1 border-b border-gray-800 hover:bg-gray-900">
                                            <div className="text-white text-xs font-bold truncate flex-1">{driver}</div>
                                            <div className="flex gap-3 text-xs">
                                                <div>
                                                    <span className="text-gray-400">AVG:</span>{' '}
                                                    <span className="orbitron text-cyan-400 font-bold">{formatTimeShort(stats.average)}</span>
                                                </div>
                                                <div>
                                                    <span className="text-gray-400">STINTS:</span>{' '}
                                                    <span className="orbitron text-white">{stats.stintCount}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Stint List */}
                        <div className="text-gray-400 text-xs mb-1">ALL STINTS</div>
                        <div className="space-y-1 max-h-[200px] overflow-y-auto">
                            {raceState.stintHistory.length === 0 ? (
                                <div className="text-center text-gray-500 py-4 text-xs">NO DATA</div>
                            ) : (
                                raceState.stintHistory.slice().reverse().map((stint, index) => {
                                    const num = raceState.stintHistory.length - index;
                                    return (
                                        <div key={index} className={`stint-card p-1 rounded-none ${stint.targetMet && !stint.overMax ? 'target-met' : stint.overMax ? 'over-max' : ''}`}>
                                            <div className="flex justify-between items-start text-xs">
                                                <div>
                                                    <div className="orbitron text-gray-400">#{num}</div>
                                                    <div className="text-white font-bold truncate">{stint.driver}</div>
                                                </div>
                                                <div className="orbitron text-sm font-bold text-white">{formatTimeShort(stint.duration)}</div>
                                            </div>
                                            <div className="mt-1">
                                                {stint.overMax ? (
                                                    <span className="text-xs px-1 bg-red-600 text-white font-bold">OVER</span>
                                                ) : stint.targetMet ? (
                                                    <span className="text-xs px-1 bg-green-600 text-white font-bold">OK</span>
                                                ) : (
                                                    <span className="text-xs px-1 bg-yellow-600 text-white font-bold">SHORT</span>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [carsConfig, setCarsConfig] = useState(null);
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [settings, setSettings] = useState({
                targetStintTime: 30,
                maxStintTime: 45,
                totalRaceTime: 6,
                maxDriverChanges: 12,
                plannedChanges: 11,
                simulationMode: false,
                equalizeDrivers: false
            });

            useEffect(() => {
                loadConfig();
                loadSettings();
            }, []);

            const loadConfig = async () => {
                const res = await fetch('/api/cars');
                const data = await res.json();
                setCarsConfig(data);
            };

            const loadSettings = async () => {
                const res = await fetch('/api/settings');
                setSettings(await res.json());
            };

            const updateSettings = async () => {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                setSettingsOpen(false);
            };

            if (!carsConfig) {
                return <div className="flex items-center justify-center min-h-screen bg-black">
                    <div className="orbitron text-red-500 text-2xl animate-pulse">LOADING...</div>
                </div>;
            }

            return (
                <div className="min-h-screen bg-black p-2">
                    {/* Header */}
                    <div className="flex justify-between items-center mb-2">
                        <h1 className="orbitron text-xl font-black text-red-500">TWO-CAR TRACKER</h1>
                        <button onClick={() => setSettingsOpen(!settingsOpen)} className="btn rounded-none">SETTINGS</button>
                    </div>

                    {/* Settings */}
                    {settingsOpen && (
                        <div className="panel rounded-none p-3 mb-2">
                            <h3 className="orbitron text-lg font-bold text-red-500 mb-2">SETTINGS</h3>
                            <div className="grid grid-cols-6 gap-2 text-xs">
                                <div>
                                    <label className="block text-gray-400 mb-1">TARGET (min)</label>
                                    <input type="number" value={settings.targetStintTime}
                                        onChange={(e) => setSettings({...settings, targetStintTime: parseInt(e.target.value)})}
                                        className="w-full px-2 py-1 bg-black border border-gray-700 text-white orbitron"
                                    />
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-1">MAX (min)</label>
                                    <input type="number" value={settings.maxStintTime}
                                        onChange={(e) => setSettings({...settings, maxStintTime: parseInt(e.target.value)})}
                                        className="w-full px-2 py-1 bg-black border border-gray-700 text-white orbitron"
                                    />
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-1">RACE (hrs)</label>
                                    <input type="number" value={settings.totalRaceTime}
                                        onChange={(e) => setSettings({...settings, totalRaceTime: parseInt(e.target.value)})}
                                        className="w-full px-2 py-1 bg-black border border-gray-700 text-white orbitron"
                                    />
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-1">PLANNED CHG</label>
                                    <input type="number" value={settings.plannedChanges}
                                        onChange={(e) => setSettings({...settings, plannedChanges: parseInt(e.target.value)})}
                                        className="w-full px-2 py-1 bg-black border border-cyan-700 text-cyan-400 orbitron font-bold"
                                    />
                                </div>
                                <div>
                                    <label className="block text-gray-400 mb-1">REQ MIN</label>
                                    <input type="number" value={settings.maxDriverChanges}
                                        onChange={(e) => setSettings({...settings, maxDriverChanges: parseInt(e.target.value)})}
                                        className="w-full px-2 py-1 bg-black border border-gray-700 text-white orbitron"
                                    />
                                </div>
                                <div className="flex gap-4">
                                    <label className="flex items-center gap-1 cursor-pointer mt-4">
                                        <input type="checkbox" checked={settings.simulationMode}
                                            onChange={(e) => setSettings({...settings, simulationMode: e.target.checked})}
                                            className="w-4 h-4"
                                        />
                                        <span className="text-white font-bold">SIM</span>
                                    </label>
                                    <label className="flex items-center gap-1 cursor-pointer mt-4">
                                        <input type="checkbox" checked={settings.equalizeDrivers}
                                            onChange={(e) => setSettings({...settings, equalizeDrivers: e.target.checked})}
                                            className="w-4 h-4"
                                        />
                                        <span className="text-white font-bold text-xs">EQUALIZE DRIVERS</span>
                                    </label>
                                </div>
                            </div>
                            <div className="flex gap-2 mt-2">
                                <button onClick={updateSettings} className="btn rounded-none flex-1">SAVE</button>
                                <button onClick={() => setSettingsOpen(false)} className="btn-sec rounded-none flex-1">CANCEL</button>
                            </div>
                        </div>
                    )}

                    {/* Two Cars Side by Side */}
                    <div className="grid grid-cols-2 gap-2" style={{height: 'calc(100vh - 100px)'}}>
                        {carsConfig.cars.map(car => (
                            <CarPanel
                                key={car.number}
                                carNumber={car.number}
                                carName={car.name}
                                drivers={car.drivers}
                            />
                        ))}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
